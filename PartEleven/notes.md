### 重构API



#### 将查询函数和修改函数分离

- 动机：如果一个函数即有返回值，又有副作用，可以进行分离
- 做法：
  - 复制整个函数，将其作为一个查询来命名
  - 从新建的查询函数中去掉所有造成副作用的语句
  - 执行静态检查
  - 查找所有调用原函数的地方。如果调用处用到了该函数的返回值，就将其改为调用新建的查询函数，并在下面马上再调用一次原函数。每次修改之后都要测试
  - 从原函数中去掉返回值
  - 测试


#### 函数参数化

- 动机：如果两个函数逻辑非常相似，只有一些字面量值不同，可以对函数进行合并
- 做法：
  - 从一组相似的函数中选择一个
  - 运用`改变函数声明`，把需要作为参数传入的字面量添加到参数列表中
  - 修改该函数所有的调用处，使其在调用时传入该字面量值
  - 测试
  - 修改函数体，令其使用新传入的参数。每使用一个参数都要测试
  - 对于其他与之相似的函数，逐一将其调用处改为调用已经参数化的函数。每次修改后都要测试


#### 移除标记参数

- 动机：如果使用标记参数对函数逻辑进行切分，会影响内部的控制流，并且并不是程序中流动的数据，可以去掉标记参数，使代码更简洁
- 做法：
  - 针对参数的每一种可能值，新建一个明确函数
  - 对于`用字面量值作为参数`的函数调用者，将其改为调用新建的明确函数


#### 保持对象完整

- 动机：如果在一个记录结构中导出几个值，然后又把这几个值一起传递给一个函数，更愿意把整个记录结构传给对象
- 做法：
  - 新建一个空函数，给它以期望中的参数列表(即传入完整对象作为参数)
  - 在新函数体内调用就函数，并把新的参数(即完整对象)映射到旧的参数列表(即来源于完整对象的各项数据)
  - 执行静态检查
  - 逐一修改旧函数的调用者，令其使用新函数，每次修改之后执行测试
  - 所有调用处都修改过来之后，使用`内联函数`把旧函数内联到新函数体内
  - 给新函数改名，从重构开始时的容易搜索的临时名字，改为使用旧函数的名字，同时修改所有调用处


#### 以查询取代参数

- 动机：如果函数可以承担查询正确的参数，那么可以在函数中查询
- 做法：
  - 如果有必要，使用`提炼函数`将参数的计算过程提炼到一个独立的函数中
  - 将函数体内引用该参数的地方改为调用新建的函数。每次修改后执行测试
  - 全部替换完成后，使用`改变函数声明`将该参数去掉